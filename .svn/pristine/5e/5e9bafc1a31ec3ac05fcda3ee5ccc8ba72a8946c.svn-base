/*
 * Made by:
 * Uroš Podkrižnik
 * uros.podkriznik(at)gmail.com
 * Tel.: 041829380
 */

package enklikanketa.com.a1kapanel.System;

import android.content.ContentValues;
import android.content.Context;
import android.database.Cursor;
import android.database.sqlite.SQLiteDatabase;
import android.database.sqlite.SQLiteOpenHelper;
import android.util.Log;

import java.io.File;
import java.util.HashMap;
import java.util.Map;

public class Database extends SQLiteOpenHelper {

    /**
     * Ko se naredi upgrade baze, je treba popravit v funkciji createDatabase(), dodati case v
     * onUpgrade() in popravit konstanto DATABASE_VERSION
     */
    private static final int DATABASE_VERSION = 1;
    //private Context context;

    public Database(Context cont) {
        super(cont, "1kapanel_baza", null, DATABASE_VERSION);
        //context = cont;
    }

    @Override
    public void onCreate(SQLiteDatabase db) {
        createDatabase(db);

        //insert device data
        ContentValues[] valuesArr = getDeviceInfoValues();
        for(ContentValues values : valuesArr)
            insertData(db, "device_info", values);
    }

    @Override
    public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion) {
        while (oldVersion <= newVersion)
        {
            switch (oldVersion)
            {
                /*case 1:
                    Log.d("1kapanel", "Database upgraded 1.");
                    db.execSQL("CREATE TABLE IF NOT EXISTS device_info "
                            + "(name VARCHAR, value VARCHAR);");
                    break;
                case 2:
                    Log.d("1kapanel", "Database upgraded 2.");
                    break;*/
            }
            oldVersion++;
        }
    }

    @Override
    public void onDowngrade(SQLiteDatabase db, int oldVersion, int newVersion) {
        while (oldVersion >= newVersion)
        {
            switch (oldVersion)
            {
                /*case 1:
                    Log.d("1kapanel", "Database upgraded 1.");
                    break;
                case 2:
                    Log.d("1kapanel", "Database upgraded 2.");
                    break;*/
            }
            oldVersion--;
        }
    }


    /**
     * get DB of app
     *
     * @param ctx Context
     * @return SQLiteDatabase 1kapanel_baza
     */
    static private SQLiteDatabase openDb(Context ctx) {
        return ctx.openOrCreateDatabase("1kapanel_baza", 0, null);
    }

    /**
     * Update DB - remove all tables and create new ones <br>
     * <b>This function will remove all stored data</b>
     *
     * @param db SQLiteDatabase
     */
    static private void createDatabase(SQLiteDatabase db) {
        try {
            //tabela, kjer je shranjen uporabnik
            db.execSQL("DROP TABLE IF EXISTS uporabnik;");
            db.execSQL("CREATE TABLE IF NOT EXISTS uporabnik "
                    + "(id INTEGER PRIMARY KEY, identifier VARCHAR, id_server INTEGER);");
            db.execSQL("CREATE TABLE IF NOT EXISTS device_info "
                    + "(name VARCHAR, value VARCHAR);");
        } catch (Exception e) {
            Log.e("1kapanel", "Database.upgradeDatabase() - Error: " + e.getMessage());
        }
    }//upgradeDatabase

    /**
     * Delete data from table
     * <br>db.execSQL("DELETE FROM " + table + ";");
     *
     * @param ctx   Context
     * @param table name of table
     */
    static public void deleteAllRows(Context ctx, String table) {
        try {
            SQLiteDatabase db = openDb(ctx);

            db.execSQL("DELETE FROM " + table + ";");

            db.close();
        } catch (Exception e) {
            Log.e("1kapanel", "Database.deleteAllRows() - Error: " + e.getMessage());
        }
    }//deleteAllRows

    /**
     * Get data from app's DB for one array (one survey, one question,...)
     * unique ID is usualy in where statement
     *
     * @param ctx     Context
     * @param table   name of table
     * @param columns wanted columns to get
     * @param where   where statement, null if not needed (eg for user email)
     * @return String array of data
     */
    static public String[] getData(Context ctx, String table, String[] columns, String where) {
        String[] temp_array = null;

        try {
            SQLiteDatabase db = openDb(ctx);
            Cursor c = db.query(table, columns, where, null, null, null, null);
            if (c.getCount() != 0) {
                temp_array = new String[c.getColumnCount()];
                c.moveToFirst();
                for (int i = 0; i < c.getColumnCount(); i++) {
                    temp_array[i] = c.getString(i);
                }
            } else {
                Log.d("1kapanel", "Database.getData() - No data");
            }
            c.close();
            db.close();
            return temp_array;
        } catch (Exception e) {
            Log.e("1kapanel", "Database.getData() - Error: " + e.getMessage());
            return null;
        }
    }//getData

    /**
     * Insert new row in DB
     *
     * @param ctx     Context
     * @param table   name of table
     * @param podatki data to insert - eg {{ "name_of_column", "value" },...}
     * @return id of new row - int id = getLastID(db);
     */
    static public String insertData(Context ctx, String table, String[][] podatki) {
        try {
            SQLiteDatabase db = openDb(ctx);

            String values = "", columns = "";

            //kreiraj string vrstic in vrednosti
            for (int i = 0; i < podatki.length; i++) {
                if (podatki[i][1] != null) {
                    if (i == 0) {
                        columns = podatki[i][0];
                        values = "'" + podatki[i][1].replaceAll("'", "''") + "'";
                    } else {
                        columns += ", " + podatki[i][0];
                        values += ", '" + podatki[i][1].replaceAll("'", "''") + "'";
                    }
                }
            }

            db.execSQL("INSERT INTO " + table + " (" + columns + ") "
                    + "VALUES (" + values + ");");

            //pridobi nazadnje pridobljen id
            int id = getLastID(db, table);
            db.close();
            return id + "";
        } catch (Exception e) {
            Log.e("1kapanel", "Database.insertData() - Error: " + e.getMessage());
            return null;
        }
    }//insertData

    /**
     * Get data from app's DB for multiple arrays
     *
     * @param ctx     Context
     * @param table   name of table
     * @param columns wanted columns to get
     * @param where   where statement, null if not needed
     * @return String[ROW_INDEX][VALUES] of data
     */
    static public String[][] getPairData(Context ctx, String table, String[] columns, String where) {
        String[][] temp_array = null;

        try {
            SQLiteDatabase db = openDb(ctx);

            Cursor c = db.query(table, columns, where, null, null, null, null);
            if (c.getCount() != 0) {
                temp_array = new String[c.getCount()][c.getColumnCount()];
                c.moveToFirst();
                do{
                    for (int col = 0; col < c.getColumnCount(); col++) {
                        temp_array[c.getPosition()][col] = c.getString(col);
                    }
                }
                while (c.moveToNext());
            } else {
                Log.d("1kapanel", "Database.getData() - No data");
            }
            c.close();
            //db.close();
            return temp_array;
        } catch (Exception e) {
            Log.e("1kapanel", "Database.getData() - Error: " + e.getMessage());
            return null;
        }
    }//getData

    /**
     * Update row in DB
     *
     * @param ctx     Context
     * @param table   name of table
     * @param podatki ContentValues values
     * @return id of new row - int id = getLastID(db);
     */
    static public int updateData(Context ctx, String table, ContentValues podatki, String where) {
        try {
            SQLiteDatabase db = openDb(ctx);

            int numRows = 0;

            if(podatki.size() > 0)
                numRows = db.update(table, podatki, where, null);
            else
                Log.w("1kapanel", "Database.insertData() - no data to insert");

            //db.close();
            return numRows;
        } catch (Exception e) {
            Log.e("1kapanel", "Database.insertData() - Error: " + e.getMessage());
            return 0;
        }
    }//insertData

    /**
     * Insert new row in DB
     *
     * @param db     SQLiteDatabase
     * @param table   name of table
     * @param podatki ContentValues values
     * @return id of new row or -1 if nothing inserted;
     */
    static public long insertData(SQLiteDatabase db, String table, ContentValues podatki) {
        try {
            long id = -1;

            if(podatki.size() > 0)
                id = db.insert(table, null, podatki);
            else
                Log.w("1kapanel", "Database.insertData() - no data to insert");

            //db.close();
            return id;
        } catch (Exception e) {
            Log.e("1kapanel", "Database.insertData() - Error: " + e.getMessage());
            return -1;
        }
    }//insertData

    /**
     * Convert HashMap<String, String> to ContentValues
     * @param podatki data to convert
     * @return converted ContentValues
     */
    static public ContentValues convertToValues(HashMap<String, String> podatki){
        ContentValues values = new ContentValues();
        for (Map.Entry<String, String> entry : podatki.entrySet()){
            if (entry.getKey() != null || entry.getValue() != null)
                values.put(entry.getKey(), entry.getValue());
            else
                Log.w("1kapanel", "Database.insertData() - null value in pair: " + entry.getKey() + " = " + entry.getValue());
        }
        return values;
    }

    /**
     * Convert String[][] to ContentValues
     * @param podatki data to convert - eg {{ "name_of_column", "value" },...}
     * @return converted ContentValues
     */
    static public ContentValues convertToValues(String[][] podatki){
        ContentValues values = new ContentValues();
        for (String[] pair : podatki){
            if (pair[0] != null || pair[1] != null)
                values.put(pair[0], pair[1]);
            else
                Log.w("1kapanel", "Database.insertData() - null value in pair: " + pair[0] + " = " + pair[1]);
        }
        return values;
    }

    /**
     * Count rows in table
     *
     * @param ctx   Context
     * @param table name of table to count rows
     * @param where where statement, null if not needed
     * @return number (int) of rows counted
     */
    static public int stejData(Context ctx, String table, String where) {
        try {
            SQLiteDatabase db = openDb(ctx);
            Cursor c = db.query(table, null, where, null, null, null, null);

            //if there is no rows in table
            if (c.getCount() == 0) {
                c.close();
                db.close();
                return 0;
            }

            c.close();
            db.close();
            return c.getCount();
        } catch (Exception e) {
            Log.e("1kapanel", "Database.stejData - Error: " + e.getMessage());
            return 0;
        }
    }//stejData

    /**
     * Get ID of last added row in DB
     *
     * @param db    DB of 1ka app
     * @param table name of table
     * @return ID of last added row (int)
     */
    private static int getLastID(SQLiteDatabase db, String table) {
        Cursor cur;
        if (table.equals(""))
            cur = db.rawQuery("SELECT last_insert_rowid()", null);
        else
            cur = db.rawQuery("SELECT ROWID from " + table + " order by ROWID DESC limit 1", null);

        if (cur.getCount() != 0) {
            cur.moveToFirst();
            int ID = cur.getInt(0);
            cur.close();
            return ID;
        } else
            return 0;
    }//getLastID

    /**
     * Create ContentValues of device info, ready to insert them in DB
     * @return ContentValues of device info
     */
    static private ContentValues[] getDeviceInfoValues() {
        String [][] pairsArr = {{"os_version", System.getProperty("os.version")+""},
                {"incremental", android.os.Build.VERSION.INCREMENTAL+""},
                {"sdk_int", android.os.Build.VERSION.SDK_INT+""},
                {"release", android.os.Build.VERSION.RELEASE+""},
                {"device", android.os.Build.DEVICE+""},
                {"model", android.os.Build.MODEL+""},
                {"product", android.os.Build.PRODUCT+""},
                {"brand", android.os.Build.BRAND+""},
                {"manufacturer", android.os.Build.MANUFACTURER+""},
                {"serial", android.os.Build.SERIAL+""},
                {"display", android.os.Build.DISPLAY+""},
                {"unknown", android.os.Build.UNKNOWN+""},
                {"hardware", android.os.Build.HARDWARE+""},
                {"id", android.os.Build.ID+""},
                {"user", android.os.Build.USER+""},
                {"host", android.os.Build.HOST+""},
                {"rooted", findBinary("su")+""},};


        ContentValues[] valuesArr = new ContentValues[pairsArr.length];
        for(int i = 0; i < pairsArr.length; i++){
            ContentValues values = new ContentValues();
            values.put("name", pairsArr[i][0]);
            values.put("value", pairsArr[i][1]);
            valuesArr[i] = values;
        }

        return valuesArr;
    }//end getDeviceSuperInfo

    //Find out if device is rooted

    /**
     * Find out fi device is rooted
     * @param binaryName - string to find (usualy "su")
     * @return boolean - true for rooted, false for otherwise
     */
    private static boolean findBinary(String binaryName) {
        boolean found = false;
        String[] places = { "/sbin/", "/system/bin/", "/system/xbin/",
                "/data/local/xbin/", "/data/local/bin/",
                "/system/sd/xbin/", "/system/bin/failsafe/", "/data/local/" };
        for (String where : places) {
            if (new File(where + binaryName).exists()) {
                found = true;

                break;
            }
        }
        return found;
    }
}
