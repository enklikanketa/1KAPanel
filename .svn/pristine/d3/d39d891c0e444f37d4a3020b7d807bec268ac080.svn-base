/*
 * Made by:
 * Uroš Podkrižnik
 * uros.podkriznik(at)gmail.com
 * Tel.: 041829380
 */

package enklikanketa.com.a1kapanel;

import android.app.Activity;
import android.app.ProgressDialog;
import android.content.Context;
import android.os.AsyncTask;
import android.os.Bundle;
import android.support.v7.app.AppCompatActivity;
import android.util.Log;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.Button;
import android.widget.Toast;

import org.json.JSONException;
import org.json.JSONObject;

import java.lang.ref.WeakReference;

import enklikanketa.com.a1kapanel.Libraries.GeneralLib;
import enklikanketa.com.a1kapanel.System.Database;
import enklikanketa.com.a1kapanel.System.ServerCommunication;
import enklikanketa.com.a1kapanel.Tasks.sendGetActivitiesTask;
import enklikanketa.com.a1kapanel.Tasks.sendGetAlarmsTask;
import enklikanketa.com.a1kapanel.Tasks.sendGetGeofencesTask;
import enklikanketa.com.a1kapanel.Tasks.sendGetTrackingTask;


public class SurveyConsent extends AppCompatActivity {

    private String TAG = "SurveyConsent";

    String new_identifier;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.survey_consent);

        boolean tracking = false, sensors = false;

        Bundle bundle = getIntent().getExtras();
        if(bundle != null && bundle.getString("new_identifier") != null &&
                !bundle.getString("new_identifier").equals("")) {
            new_identifier = bundle.getString("new_identifier");

            tracking = bundle.getBoolean("tracking");
            sensors = bundle.getBoolean("sensors");
        }
        else{
            GeneralLib.reportCrash(new Exception("SurveyConsent.class onCreate() problem in bundle or new_identifier key"), null);
            finish();
        }

        if(tracking)
            findViewById(R.id.consent_permission_locat).setVisibility(View.VISIBLE);
        if(sensors)
            findViewById(R.id.consent_permission_sens).setVisibility(View.VISIBLE);

        Button buttonConsent = findViewById(R.id.consent_accept);
        buttonConsent.setOnClickListener(new OnClickListener() {
            public void onClick(View v) {
                new MergeTask(SurveyConsent.this).execute();
            }
        });
        Button buttondecline = findViewById(R.id.consent_decline);
        buttondecline.setOnClickListener(new OnClickListener() {
            public void onClick(View v) {
                finish();
            }
        });
    }

    private class MergeTask extends AsyncTask<Object, Object, String> {

        private final WeakReference<Activity> act;
        ProgressDialog loader;
        Database DB;

        MergeTask (Activity act){
            this.act = new WeakReference<>(act);
            DB = (Database) Database.getInstance(act);
        }

        @Override
        protected void onPreExecute() {
            super.onPreExecute();
            loader = ProgressDialog.show(act.get(), "",
                    act.get().getResources().getString(R.string.gathering_data_progress), true);
        }

        @Override
        protected void onPostExecute(String result) {
            super.onPostExecute(result);
            if (result != null && GeneralLib.isActivityValid(act.get())) {
                try {
                    JSONObject obj = new JSONObject(result);

                    if (obj.has("note")) {
                        if (obj.getString("note").equals("merge OK")) {
                            //check and save new repeaters if exists
                            new sendGetAlarmsTask(act.get()).execute();
                            //get geofences of surveys of this user
                            new sendGetGeofencesTask(act.get()).execute();
                            //get activities of surveys of this user
                            new sendGetActivitiesTask(act.get()).execute();
                            //get tracking of surveys of this user
                            new sendGetTrackingTask(act.get()).execute();

                            GeneralLib.dismissDialog(act.get(), loader);
                            Toast.makeText(act.get(), act.get().getString(R.string.identifiers_merged)
                                , Toast.LENGTH_LONG).show();
                            finish();
                        }
                        else
                            GeneralLib.reportCrash(new Exception("SurveyConsent.class onPostExecute() has unknown note: "
                                    + result), null);
                    } else {
                        Log.e(TAG, "SurveyConsent.class onPostExecute() result: " + result);
                        if (obj.has("error")) {

                            if(obj.getString("error").equals("identifier does not exist")) {
                                GeneralLib.dismissDialog(act.get(), loader);
                                Toast.makeText(act.get(), act.get().getString(R.string.identifierNotExist)
                                        , Toast.LENGTH_LONG).show();
                            }
                            //no user in DB yet
                            else if(obj.getString("error").equals("no data")){}

                                /*if (!GeneralLib.otherErrors(Main.this, obj.getString("error"))) {
                                    GeneralLib.reportCrash(new Exception("Main.class onPostExecute() has error: "
                                            + obj.getString("error")), null);
                                }*/
                        } else
                            GeneralLib.reportCrash(new Exception("SurveyConsent.class onPostExecute() has unknown response: "
                                    + result), null);
                    }
                } catch (JSONException e) {
                    //Log.e(TAG, "Main.class onPostExecute(): " + e);
                    GeneralLib.reportCrash(e, result);
                }
            }
            //ce je null, pomeni da server ni dosegljiv ali pa so druge napake
            else {
                //Log.e(TAG, "Main.class onPostExecute() result is null ");
                if(GeneralLib.isActivityValid(act.get()))
                    GeneralLib.showErrorToUser(act.get(), act.get().getString(R.string.general_remote_server_error));
            }
            GeneralLib.dismissDialog(act.get(), loader);
        }

        @Override
        protected String doInBackground(Object... params) {
            if (GeneralLib.isActivityValid(act.get())) {
                String[] uporabnik = DB.getRowData("uporabnik",
                        new String[]{"identifier", "id_server"}, null);
                if(uporabnik != null && new_identifier != null)
                    return postMergeIdentifier(act.get(), uporabnik[0], uporabnik[1]);
                else
                    return "{error: \"no data\"}";
            }
            else
                return null;
        }
    }

    private String postMergeIdentifier(Context ctx, String identifier, String id_server) {
        // poslji
        JSONObject object = new JSONObject();

        // uporabnik prijavljen
        try {
            JSONObject logIn = new JSONObject();
            logIn.put("identifier", identifier);
            logIn.put("id_server", id_server);
            //just in case, if registration id is not updated (cleared data...)
            object.put("identifierToMerge", new_identifier);
            object.put("Login", logIn);

        } catch (JSONException e) {
            //Log.e(TAG, "Or could not parse malformed JSON: \"" + object.toString() + "\"");
            GeneralLib.reportCrash(e, object.toString());
        }

        ServerCommunication SC = new ServerCommunication(ctx);
        return SC.PostMergeIdentifier(object);
    }
}
