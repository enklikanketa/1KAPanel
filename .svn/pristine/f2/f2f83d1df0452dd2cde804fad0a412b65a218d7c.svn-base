package enklikanketa.com.a1kapanel;

import android.app.Activity;
import android.os.Bundle;
import android.support.annotation.StyleRes;
import android.support.v7.app.AppCompatDialog;
import android.text.Editable;
import android.text.TextWatcher;
import android.util.Log;
import android.view.View;
import android.widget.Button;
import android.widget.EditText;
import android.widget.LinearLayout;
import android.widget.TextView;

import org.json.JSONException;
import org.json.JSONObject;

import enklikanketa.com.a1kapanel.Libraries.GeneralLib;

/**
 * Created by Developer on 29.6.2017.
 */

public class DialogPrivateName extends AppCompatDialog {

    private Activity act;
    private int location_id;
    private Button ok_button;

    // This is the reference to the associated listener
    private final TaskListener taskListener;

    DialogPrivateName(Activity act, @StyleRes int themeResId, int activity_id, TaskListener listener) {
        super(act, themeResId);
        this.act = act;
        this.location_id = activity_id;
        this.taskListener = listener;
    }

    public interface TaskListener {
        void onFinished(String result);
    }

    @Override
    public void onCreate(Bundle savedInstanceState) {
        setContentView(R.layout.dialog_private_name);

        EditText otherName = (EditText) findViewById(R.id.editTextOther);
        ok_button = (Button) findViewById(R.id.buttonOtherOK);
        if(otherName != null) {
            otherName.addTextChangedListener(otherWatcher);
            ok_button.setOnClickListener(new customOnClickListener(otherName.getText().toString()));
        }

        String[] actArr = act.getResources().getStringArray(R.array.staypoint_private_names);
        LinearLayout uad_parent = (LinearLayout) findViewById(R.id.pnd_list);

        for (String actStr : actArr) {
            View optionView = View.inflate(act, R.layout.dialog_user_activity_item, null);
            TextView optionTextView = optionView.findViewById(R.id.textView);
            optionTextView.setText(actStr);

            optionView.setOnClickListener(new customOnClickListener(actStr));

            if (uad_parent != null)
                uad_parent.addView(optionView);
        }
    }

    private class customOnClickListener implements View.OnClickListener {

        String var;

        private customOnClickListener(String var) {
            this.var = var;
        }

        @Override
        public void onClick(View v) {
            // poslji
            JSONObject object = new JSONObject();

            // uporabnik prijavljen
            try {
                object.put("personalized_location", var);
                object.put("validated", true);
                object.put("location_id", location_id);
            } catch (JSONException e) {
                //Log.e("1kapanel", "Could not parse malformed JSON: \"" + object.toString() + "\"");
                GeneralLib.reportCrash(e, object.toString());
            }
            Log.d("1kapanel", "location_id : " + location_id + var);
            new sendNextPinEditTask(act, location_id, object, "editFrequent",
                    new sendNextPinEditTask.TaskListener() {
                        @Override
                        public void onFinished(String result) {
                            if (taskListener != null)
                                taskListener.onFinished(result);
                        }
                    }).execute();
            DialogPrivateName.this.dismiss();
        }
    }

    private final TextWatcher otherWatcher = new TextWatcher() {
        public void beforeTextChanged(CharSequence s, int start, int count, int after) {

        }

        public void onTextChanged(CharSequence s, int start, int before, int count) {
            //ok_button.setVisibility(View.VISIBLE);
        }

        public void afterTextChanged(Editable s) {
            if (s.length() == 0) {
                ok_button.setVisibility(View.GONE);
            } else{
                ok_button.setVisibility(View.VISIBLE);
            }
        }
    };
}

